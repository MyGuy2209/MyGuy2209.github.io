<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        canvas{

            overflow: hidden;
        }



    </style>
</head>

<body>


<div id="score"></div>
<canvas id="tetris" width="240" height="400">
</canvas>


<script>

const canvas = document.querySelector("#tetris");
const ctx = canvas.getContext("2d");

ctx.scale(20,20);



gameLoop();


function gameLoop () {


    const brikke = [
        [0, 1,0 ],
        [0, 1,  0],
        [1, 1, 0]
    ];

    function kollisjon(world, spiller) {
        const[m, o] = [spiller.brikke, spiller.pos];
        for (let y = 0; y < m.length; ++y){
            for (let x =0; x < m[y].length; ++x){
                if (m[y][x] !== 0 &&
                    (world[y + o.y] &&
                    world[y+ o.y ][x + o.x]) !== 0)  {
                    return true;
                }

            }
        }
        return false;
    }

    function createBox (w, h) {
        const brikke = [];

        while( h--){
            brikke.push(new Array(w).fill(0));

        }
        return brikke;
    }
    ///

    function draw() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawBrikke(world, {x:0, y:0});
        drawBrikke(spiller.brikke, spiller.pos);

    }

    function drawBrikke(brikke, offset) {
        brikke.forEach((row, y) => {
            row.forEach((value, x) => {
                if (value !== 0) {
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(x + offset.x, y + offset.y, 1, 1)
                }

            });
        });
    }

    function merge(world, spiller){
        spiller.brikke.forEach((row, y ) => {
        row.forEach((value, x) => {
                if(value !== 0 ){
                    world[y + spiller.pos.y] [x + spiller.pos.x] = value;
                }
            })
        })

    }

    function spillerDrop (){

        spiller.pos.y++;
        if(kollisjon(world, spiller)){
            spiller.pos.y--;

            merge(world, spiller);
            spiller.pos.y=0;
        }
        dropTeller = 0;
    }


    function spillerMove(vei){
        spiller.pos.x += vei;
        if(kollisjon(world, spiller)){
            spiller.pos.x -=vei;
        }
    }

    function spillerRotate(vei){
      rotate(spiller.brikke, vei)


    }

function rotate(brikke, vei){
    for(let y =0; y< brikke.length; ++y){
        for(let x =0; x<y; ++x){
            [
                brikke[x][y],
                brikke[y][x],
            ] = [

                brikke[y][x],
                brikke[x][y],
            ];
        }
    }
    if(vei > 0) {
        brikke.forEach(row => row.reverse());
    } else {
        brikke.reverse();
    }
}




    let dropTeller = 0;
    let dropInterval = 600;


    let forrigeTid = 0;

    function update(time = 0) {
        let  endringTid = time - forrigeTid;

        forrigeTid = time;


        dropTeller += endringTid;
        if (dropTeller > dropInterval) {
         spillerDrop()

        }

        draw();
        window.requestAnimationFrame(update);
    }

    const world = createBox(12, 20);

    const spiller = {
        pos: {x: 4, y: 2},
        brikke: brikke,
    };

        document.addEventListener('keydown', event => {
        if(event.code === "ArrowLeft"){
            spillerMove(-1);
        } else if (event.code === "ArrowRight") {
            spillerMove(1)
        }
        else if(event.code === "ArrowDown") {
            spillerDrop();
        } else if (event.code ==="ArrowUp"){
            spillerRotate(-1)

        }
        });


    update();

}





</script>
</body>
</html>